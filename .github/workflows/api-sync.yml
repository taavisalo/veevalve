name: Sync API Data

on:
  workflow_dispatch:
  schedule:
    - cron: '17 */2 * * *'

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Preflight secrets
        id: preflight
        env:
          SYNC_API_URL: ${{ secrets.SYNC_API_URL }}
          SYNC_API_TOKEN: ${{ secrets.SYNC_API_TOKEN }}
        run: |
          missing=0
          for secret_name in SYNC_API_URL SYNC_API_TOKEN; do
            if [ -z "${!secret_name:-}" ]; then
              echo "Missing required secret: $secret_name"
              missing=1
            fi
          done

          if [ "$missing" -eq 1 ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Skipping sync because SYNC_API_URL or SYNC_API_TOKEN is missing."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Trigger sync endpoint
        if: steps.preflight.outputs.skip != 'true'
        env:
          SYNC_API_URL: ${{ secrets.SYNC_API_URL }}
          SYNC_API_TOKEN: ${{ secrets.SYNC_API_TOKEN }}
        run: |
          set -eu

          response_file="$(mktemp)"
          status_code="$(curl --silent --show-error --location --max-time 120 \
            --output "$response_file" \
            --write-out '%{http_code}' \
            --request POST "$SYNC_API_URL" \
            --header "X-Sync-Token: $SYNC_API_TOKEN" \
            --header 'Content-Type: application/json' \
            --data '{}')"

          echo "HTTP status: $status_code"
          echo "Response:"
          cat "$response_file"
          echo

          if [ "$status_code" -lt 200 ] || [ "$status_code" -ge 300 ]; then
            echo "Sync failed"
            exit 1
          fi

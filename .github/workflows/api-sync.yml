name: Sync API Data

on:
  workflow_dispatch:
  schedule:
    - cron: '17 */2 * * *'

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ secrets.SYNC_API_URL != '' && secrets.SYNC_API_TOKEN != '' }}

    steps:
      - name: Trigger sync endpoint
        env:
          SYNC_API_URL: ${{ secrets.SYNC_API_URL }}
          SYNC_API_TOKEN: ${{ secrets.SYNC_API_TOKEN }}
        run: |
          set -eu

          response_file="$(mktemp)"
          status_code="$(curl --silent --show-error --location --max-time 120 \
            --output "$response_file" \
            --write-out '%{http_code}' \
            --request POST "$SYNC_API_URL" \
            --header "X-Sync-Token: $SYNC_API_TOKEN" \
            --header 'Content-Type: application/json')"

          echo "HTTP status: $status_code"
          echo "Response:"
          cat "$response_file"
          echo

          if [ "$status_code" -lt 200 ] || [ "$status_code" -ge 300 ]; then
            echo "Sync failed"
            exit 1
          fi

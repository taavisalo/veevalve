generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlaceType {
  BEACH
  POOL
}

enum QualityStatus {
  GOOD
  BAD
  UNKNOWN
}

enum WaterSource {
  TERVISEAMET_XML
}

enum AuthProvider {
  GOOGLE
  APPLE
  MICROSOFT
  TARA
  OTHER
}

model User {
  id              String                   @id @default(cuid())
  email           String?                  @unique
  displayName     String?
  preferredLocale String                   @default("et")
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  identities      UserIdentity[]
  favorites       Favorite[]
  notifications   NotificationPreference[]
}

model UserIdentity {
  id             String       @id @default(cuid())
  userId         String
  provider       AuthProvider
  providerUserId String
  createdAt      DateTime     @default(now())
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
}

model Place {
  id           String                  @id @default(cuid())
  externalId   String                  @unique
  nameEt       String
  nameEn       String
  type         PlaceType
  municipality String
  addressEt    String?
  addressEn    String?
  latitude     Float
  longitude    Float
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  readings     WaterQualityReading[]
  favorites    Favorite[]
  preferences  NotificationPreference[]

  @@index([type])
  @@index([municipality])
}

model WaterQualityReading {
  id             String        @id @default(cuid())
  placeId        String
  sampledAt      DateTime
  status         QualityStatus
  statusReasonEt String
  statusReasonEn String
  source         WaterSource
  sourceUrl      String
  createdAt      DateTime      @default(now())
  place          Place          @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@index([placeId, sampledAt(sort: Desc)])
  @@unique([placeId, sampledAt, status])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  placeId   String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  place     Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@unique([userId, placeId])
  @@index([placeId])
}

model NotificationPreference {
  id                 String   @id @default(cuid())
  userId             String
  placeId            String?
  pushToken          String
  qualityChangeAlert Boolean  @default(true)
  locationAlert      Boolean  @default(false)
  radiusMeters       Int      @default(1000)
  enabled            Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  place              Place?   @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([placeId])
}

model NotificationEvent {
  id               String   @id @default(cuid())
  preferenceId     String
  placeId          String
  previousStatus   QualityStatus
  currentStatus    QualityStatus
  sentAt           DateTime @default(now())
  createdAt        DateTime @default(now())

  @@index([preferenceId])
  @@index([placeId])
}
